# patch configure to x-build
# patch mythmusic to play Win32 d:/... filenames
# patch mythgallery to load images on Win32
Index: mythplugins/configure
===================================================================
--- mythplugins/configure	(revision 27285)
+++ mythplugins/configure	(working copy)
@@ -234,6 +234,8 @@
 for opt do
   optval="${opt#*=}"
   case "$opt" in
+  --targetos=*) targetos=`echo $opt | cut -d '=' -f 2`
+  ;;
   --prefix=*) prefix=`echo $opt | cut -d '=' -f 2`
   ;;
   --libdir-name=*) libdir_name=`echo $opt | cut -d '=' -f 2`;
@@ -315,7 +317,7 @@
         done
     fi
 
-    LIBPATHS="`echo $LIBPATHS $sysroot$prefix/$libdir_name $sysroot/$libdir_name $sysroot/usr/$libdir_name $sysroot/usr/local/$libdir_name $sysroot/usr/X11R6/$libdir_name | sed s/'\/ '/' '/g` "
+    LIBPATHS="`echo $LIBPATHS $prefix/$libdir_name $sysroot/$libdir_name $sysroot/usr/$libdir_name $sysroot/usr/local/$libdir_name $sysroot/usr/X11R6/$libdir_name | sed s/'\/ '/' '/g` "
 
     HAS_IT="no"
     for LIBPATH in $LIBPATHS ; do
@@ -328,7 +330,7 @@
 
 has_header()
 {
-    HPATHS="$sysroot$prefix/include $sysroot/usr/local/include $sysroot/usr/include $sysroot/usr/include/g++-v3 $sysroot/usr/X11R6/include $sysroot/"
+    HPATHS="$prefix/include $sysroot/usr/local/include $sysroot/usr/include $sysroot/usr/include/g++-v3 $sysroot/usr/X11R6/include $sysroot/"
     INCL=`echo $DYLD_LIBRARY_PATH $LD_LIBRARY_PATH | sed s/':'/' '/g`
     HPATHS="$HPATHS `echo $INCL | sed s/$libdir_name/include/g` "
 
@@ -375,6 +380,9 @@ if test "$opengl" != "no" ; then
     if test -f $sysroot/System/Library/Frameworks/AGL.framework/Versions/A/AGL ; then
         opengl="yes"
     fi
+    if test "`echo ${targetos} | cut -c1-5`" = "MINGW" ; then
+        opengl="yes"
+    fi
 fi
 
 if ! disabled libvisual; then
@@ -388,11 +393,9 @@
 
 if ! disabled fftw; then
     disable fftw_lib3
-    if has_library libfftw3f_threads ; then
-        if has_library libfftw3_threads ; then
-            if has_header fftw3.h ; then
-                enable fftw_lib3
-            fi
+    if has_library libfftw3_threads ; then
+        if has_header fftw3.h ; then
+            enable fftw_lib3
         fi
     fi
 fi
@@ -585,13 +587,13 @@
 ###########################################################
 
 # bring in mythtv config
-if [ -e $sysroot$prefix/include/mythtv/mythconfig.mak ] ; then
+if [ -e $prefix/include/mythtv/mythconfig.mak ] ; then
   rm mythconfig.mak 2> /dev/null
-  ln -s $sysroot$prefix/include/mythtv/mythconfig.mak mythconfig.mak
+  ln -s $prefix/include/mythtv/mythconfig.mak mythconfig.mak
 else
-  echo "ERROR: mythconfig.mak not found at $sysroot$prefix/include/mythtv/mythconfig.mak"
+  echo "ERROR: mythconfig.mak not found at $prefix/include/mythtv/mythconfig.mak"
   echo "Did you make AND install MythTV first?"
-  echo "Are you using the correct prefix ($prefix) and sysroot ($sysroot)?"
+  echo "Are you using the correct prefix ($prefix)?"
   echo "Bailing out!!"
   exit
 fi
@@ -813,7 +832,11 @@
         if enabled sdl; then
             echo "        libvisual      support will be included in MythMusic"
             echo "#define LIBVISUAL_SUPPORT 1" >> ./mythmusic/mythmusic/config.h
-            echo "INCLUDEPATH += /usr/include/libvisual-0.4" >> ./mythmusic/mythmusic/config.pro
+            if [ "`echo ${targetos} | cut -c1-5`" = "MINGW" ]; then 
+                echo "INCLUDEPATH += $prefix/include/libvisual-0.4" >> ./mythmusic/mythmusic/config.pro
+            else
+                echo "INCLUDEPATH += `pkg-config --cflags-only-I libvisual-0.4 | sed s/-I//g`" >> ./mythmusic/mythmusic/config.pro
+            fi
             echo "LIBS += -lvisual-0.4" >> ./mythmusic/mythmusic/config.pro
         else
             echo "        libvisual      support will not be included in MythMusic (requires SDL support)"Index: mythplugins/mythmusic/mythmusic/decoderhandler.cpp
===================================================================
--- mythplugins/mythmusic/mythmusic/decoderhandler.cpp	(revision 27285)
+++ mythplugins/mythmusic/mythmusic/decoderhandler.cpp	(working copy)
@@ -267,7 +267,8 @@
     m_redirects = 0;
 
     QUrl url;
-    if (mdata->Filename().startsWith('/'))
+    // NB Win32 absolute paths start d:/...
+    if (QFileInfo(mdata->Filename()).isAbsolute())
         url = QUrl::fromLocalFile(mdata->Filename());
     else
         url.setUrl(mdata->Filename());
@@ -328,7 +329,8 @@
     PlayListFileEntry *entry = m_playlist.get(m_playlist_pos);
 
     QUrl url;
-    if (entry->File().startsWith('/'))
+    // NB Win32 absolute paths start d:/...
+    if (QFileInfo(entry->File()).isAbsolute())
         url = QUrl::fromLocalFile(entry->File());
     else
         url.setUrl(entry->File());
@@ -398,7 +400,8 @@
 
     if (extension == ".pls" || extension == ".m3u")
     {
-        if (url.scheme() == "file" || url.toString().startsWith('/'))
+        // NB Win32 absolute paths start d:/...
+        if (url.scheme() == "file" || QFileInfo(url.toString()).isAbsolute())
             return createPlaylistFromFile(url);
         else
             return createPlaylistFromRemoteUrl(url);
@@ -411,7 +414,8 @@
 {
     PlayListFileEntry *entry = new PlayListFileEntry;
 
-    if (url.scheme() == "file" || url.toString().startsWith('/'))
+    // NB Win32 absolute paths start d:/...
+    if (url.scheme() == "file" || QFileInfo(url.toString()).isAbsolute())
         entry->setFile(url.toLocalFile());
     else
         entry->setFile(url.toString());
@@ -513,7 +517,8 @@
     if (haveIOFactory()) 
         deleteIOFactory();
 
-    if (url.scheme() == "file" || url.toString().startsWith('/') || url.toString().endsWith(".cda"))
+    // NB Win32 absolute paths start d:/...
+    if (url.scheme() == "file" || QFileInfo(url.toString()).isAbsolute() || url.toString().endsWith(".cda"))
         m_io_factory = new DecoderIOFactoryFile(this);
     else if (m_meta && m_meta->Format() == "cast")
         m_io_factory = new DecoderIOFactoryShoutCast(this);
Index: mythplugins/mythgallery/mythgallery/iconview.cpp
===================================================================
--- mythplugins/mythgallery/mythgallery/iconview.cpp	(revision 27285)
+++ mythplugins/mythgallery/mythgallery/iconview.cpp	(working copy)
@@ -204,6 +204,7 @@
         m_thumbGen->setSize(thumbWidth, thumbHeight);
 
     SetupMediaMonitor();
+    LoadDirectory(m_galleryDir);
 
     return true;
 }
@@ -370,7 +371,6 @@
         }
     }
     m_currDevice = NULL;
-    LoadDirectory(m_galleryDir);
 #endif // _WIN32
 }
 
@@ -492,10 +492,10 @@
                 {
                     QDir currentDir(m_currDir);
                     QDir rootDir(m_galleryDir);
-                    if (currentDir != rootDir) 
-                        HandleSubDirEscape(m_galleryDir);
-                    else 
+                    if (currentDir == rootDir) 
                         break;
+                    if ( !HandleSubDirEscape(m_galleryDir))
+                        break;
                 }
                 handled = HandleEscape();
             }
